#!/usr/bin/env bash
set -euo pipefail

MANIFEST=""
BACKEND_BIN="./backend/target/debug/zfs-explorer"
BASE_URL="http://127.0.0.1:9000"
RUST_LOG_LEVEL="${RUST_LOG:-warn}"

usage() {
  cat <<'EOF'
Usage: sudo build/test-corpus-fixture.sh --manifest <manifest.json> [options]

Required:
  --manifest <path>      Fixture manifest generated by create-corpus-fixture.sh

Optional:
  --backend <path>       Backend binary path (default: ./backend/target/debug/zfs-explorer)
  --base-url <url>       Backend base URL (default: http://127.0.0.1:9000)
  -h, --help             Show help

Runs:
  1) Offline API smoke checks
  2) Direct ZPL download checksum checks for manifest known_files
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --manifest)
      shift
      MANIFEST="${1:-}"
      ;;
    --backend)
      shift
      BACKEND_BIN="${1:-}"
      ;;
    --base-url)
      shift
      BASE_URL="${1:-}"
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "error: unknown option '$1'" >&2
      usage >&2
      exit 2
      ;;
  esac
  shift
done

if [[ -z "$MANIFEST" ]]; then
  echo "error: --manifest is required" >&2
  exit 2
fi

if [[ ! -f "$MANIFEST" ]]; then
  echo "error: manifest not found: $MANIFEST" >&2
  exit 1
fi

for cmd in jq curl sha256sum; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "error: missing required command '$cmd'" >&2
    exit 2
  fi
done

if [[ ! -x "$BACKEND_BIN" ]]; then
  echo "error: backend binary not executable: $BACKEND_BIN" >&2
  exit 1
fi

if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
  echo "error: run as root (backend needs pool/media access)" >&2
  exit 1
fi

POOL="$(jq -r '.pool.name // empty' "$MANIFEST")"
SEARCH_PATHS="$(jq -r '.fixture.search_paths // empty' "$MANIFEST")"
if [[ -z "$POOL" || -z "$SEARCH_PATHS" ]]; then
  echo "error: manifest missing pool.name or fixture.search_paths" >&2
  exit 1
fi

echo "==> Running offline smoke checks for '$POOL'"
build/test-offline-fixture.sh \
  --pool "$POOL" \
  --search-paths "$SEARCH_PATHS" \
  --backend "$BACKEND_BIN" \
  --base-url "$BASE_URL"

LOG_FILE="$(mktemp /tmp/zdx-corpus-backend.XXXXXX.log)"
PID=""

cleanup() {
  if [[ -n "$PID" ]]; then
    kill "$PID" >/dev/null 2>&1 || true
    wait "$PID" 2>/dev/null || true
  fi
  rm -f "$LOG_FILE"
}
trap cleanup EXIT

echo "==> Starting backend for checksum validation"
(
  export ZFS_EXPLORER_POOL_MODE=offline
  export ZFS_EXPLORER_OFFLINE_POOLS="$POOL"
  export ZFS_EXPLORER_OFFLINE_PATHS="$SEARCH_PATHS"
  export RUST_LOG="$RUST_LOG_LEVEL"
  exec "$BACKEND_BIN"
) >"$LOG_FILE" 2>&1 &
PID="$!"

echo "==> Waiting for backend readiness at $BASE_URL"
for _ in $(seq 1 60); do
  if curl -sS "$BASE_URL/api/version" >/dev/null 2>&1; then
    break
  fi
  sleep 0.25
done

if ! curl -sS "$BASE_URL/api/version" >/dev/null 2>&1; then
  echo "error: backend did not become ready" >&2
  cat "$LOG_FILE" >&2
  exit 1
fi

echo "==> Verifying known file checksums"
known_count="$(jq '.known_files | length' "$MANIFEST")"
if [[ "$known_count" -eq 0 ]]; then
  echo "warning: manifest has no known_files; skipping checksum checks"
  exit 0
fi

failures=0
while IFS= read -r row; do
  path="$(jq -r '.path' <<<"$row")"
  expected="$(jq -r '.sha256' <<<"$row")"
  tmp_file="$(mktemp /tmp/zdx-corpus-file.XXXXXX.bin)"

  if ! curl -fsS --path-as-is "$BASE_URL/api/pools/$POOL/zpl/path/$path" -o "$tmp_file"; then
    echo "FAIL: download failed for $path" >&2
    failures=$((failures + 1))
    rm -f "$tmp_file"
    continue
  fi

  got="$(sha256sum "$tmp_file" | awk '{print $1}')"
  rm -f "$tmp_file"
  if [[ "$got" != "$expected" ]]; then
    echo "FAIL: checksum mismatch for $path" >&2
    echo "      expected: $expected" >&2
    echo "      got:      $got" >&2
    failures=$((failures + 1))
  else
    echo "OK: $path"
  fi
done < <(jq -c '.known_files[]' "$MANIFEST")

if [[ "$failures" -ne 0 ]]; then
  echo
  echo "Corpus validation failed: $failures checksum mismatches." >&2
  exit 1
fi

echo
echo "Corpus validation passed."
